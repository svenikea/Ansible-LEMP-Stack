- name: Nginx Role
  become: yes
  block:
    - name: Ubuntu/Debian System
      block:
        - name: Install Ubuntu Debian Nginx
          apt:
            name: nginx
            state: present

        - name: Create {{ servername }} Directory
          file:
            path: /var/www/html/{{ servername }}
            state: directory
            group: '82'
            owner: 'www-data'
            mode: '700'

      when: ansible_distribution == "Ubuntu" or ansible_distribution == "Debian"
  
    - name: CentOS/Redhat System
      block:
        - name: Install CentOS Nginx
          yum:
            name: nginx
            state: present

        - name: Create {{ servername }} Directory
          file:
            path: /var/www/html/{{ servername }}
            state: directory
            group: 'nginx'
            owner: 'nginx'
            mode: '700'

      when: ansible_distribution == "CentOS" 

    - name: Creating Nginx Directory
      file:
        state: directory 
        owner: root
        group: root
        mode: "644"
        dest: /etc/nginx/nginxconfig.io

    - name: Creating Required Config File
      template:
        src: "{{ item.source }}"
        dest: "{{ item.path }}"
        owner: root
        group: root
        mode: '744'
      with_items:
        - { path: "/etc/nginx/conf.d/{{ domain }}.conf", source: "website.j2" }
        - { path: "/etc/nginx/conf.d/nginx.conf", source: "nginx.j2" }
        - { path: "/etc/nginx/nginxconfig.io/security.conf", source: "security.j2" }
        - { path: "/etc/nginx/nginxconfig.io/general.conf", source: "general.j2" }
        - { path: "/etc/nginx/nginxconfig.io/php_fastcgi.conf", source: "php_fastcgi.j2" }
        - { path: "/etc/nginx/nginxconfig.io/wordpress.conf", source: "wordpress.j2" }

    - name: Delete Default webspage
      file:
        path: /etc/nginx/sites-enabled/default
        state: "absent"
      notify: Restart Nginx Config
